<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>A hands-on tutorial for spreco | Guanxiong Jason Luo</title> <meta name="author" content="Guanxiong Jason Luo"> <meta name="description" content="spreco, generative pretraining, image priors"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link href="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.css" rel="stylesheet"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%90%86&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://ggluo.github.io/projects/0_project/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/">Guanxiong Luo</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">Projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5"> <div class="row"> <div class="col-sm-9"> <div class="post"> <header class="post-header"> <h1 class="post-title">A hands-on tutorial for spreco</h1> <p class="post-meta">July 21, 2023</p> <p class="post-tags"> <a href="/blog/2023"> <i class="fas fa-calendar fa-sm"></i> 2023 </a>   ·   <a href="/blog/tag/spreco"> <i class="fas fa-hashtag fa-sm"></i> spreco</a>   <a href="/blog/tag/tutorials"> <i class="fas fa-hashtag fa-sm"></i> tutorials</a>     ·   <a href="/blog/category/work"> <i class="fas fa-tag fa-sm"></i> work</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <h2 id="overview">Overview</h2> <p>This post will give a brief introduction to the usage of <a href="https://github.com/mrirecon/spreco" rel="external nofollow noopener" target="_blank">spreco</a>. Spreco is a tool for MR researchers to train generative priors for image reconstruction, developed with TensorFlow. It is recommended to use it on a Linux-based system. The same to most workflows in deep learning, we can use it following steps below.</p> <ol> <li>The preparation of data</li> <li>Training of generative priors</li> <li>Export and inference</li> <li>Feedback</li> </ol> <h2 id="preparation-of-data">Preparation of data</h2> <p>Before embarking on any ML projects, the first thing come up is where to get data for training. Except collecting your own data, specifically in the field of medical imaging, there so many datasets are made publicly available for researchers. I found a list on this github <a href="https://github.com/sfikas/medical-imaging-datasets" rel="external nofollow noopener" target="_blank">repository</a>.</p> <p>Then many questions follow up. How large is the dataset? Is it necessary to do preprocessing before using it? Do I have enough computation resources to work on it? From my own experiences, the preprocessing step could be time-consuming, and it is always beneficial to parallelize your tasks. If the tasks are cpu-based, the python library <a href="https://docs.python.org/3/library/multiprocessing.html#module-multiprocessing" rel="external nofollow noopener" target="_blank">multiprocessing</a> is a good option. If the tasks are gpu-based, one possible trick is to have a small snippet for one task and then use shell script to parallelize multiple snippets for tasks over the available gpus. In the end, make sure to store processed files in an organized way.By doing this, it would be easier to define a dataloader for training. When your data is heavy and it takes long to load, here is one data loading pipeline, <a href="https://github.com/tensorpack/dataflow" rel="external nofollow noopener" target="_blank">Tensorpack DataFlow</a>, optimized for speed. To prepare data for spreco after finishing the preprocessing step, you need to create a list of training files specifying where the files are. Shell commands <code class="language-plaintext highlighter-rouge">ls</code> and <code class="language-plaintext highlighter-rouge">find</code> are so efficient to do so.</p> <div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./dataset/abide_2/train/abide_1000000.npz
./dataset/abide_2/train/abide_1000001.npz
./dataset/abide_2/train/abide_1000002.npz
./dataset/abide_2/train/abide_1000003.npz
</code></pre></div></div> <h2 id="training-of-generative-priors">Training of generative priors</h2> <p>I assume nowadays most labs are equipped with workstations that have multiple gpus, keeping track of hyperparameters needs a good deal of patience and monitoring the training is important. Spreco provides a workable solution for these things with one yaml config file.</p> <h3 id="configuration-file">Configuration file</h3> <div class="language-yml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># parameters for the model</span>
<span class="na">model</span><span class="pi">:</span> <span class="s1">'</span><span class="s">PIXELCNN'</span>
<span class="na">batch_size</span><span class="pi">:</span> <span class="m">6</span>
<span class="na">input_shape</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">256</span><span class="pi">,</span> <span class="nv">256</span><span class="pi">,</span> <span class="nv">2</span><span class="pi">]</span>
<span class="na">nr_resnet</span><span class="pi">:</span> <span class="m">3</span>
<span class="na">nr_filters</span><span class="pi">:</span> <span class="m">128</span>
<span class="na">nr_logistic_mix</span><span class="pi">:</span> <span class="m">10</span>
<span class="na">data_chns</span><span class="pi">:</span> <span class="s1">'</span><span class="s">CPLX'</span>
<span class="na">dropout_rate</span><span class="pi">:</span> <span class="m">0.5</span>
<span class="na">itg_interval</span><span class="pi">:</span> <span class="m">255.0</span>
<span class="na">rlt</span><span class="pi">:</span> <span class="m">1</span>
<span class="na">layer_norm</span><span class="pi">:</span> <span class="s">False</span>
<span class="na">conditional</span><span class="pi">:</span> <span class="s">False</span>

<span class="c1"># learning rate schedule</span>
<span class="na">lr_warm_up_steps</span><span class="pi">:</span> <span class="m">1000</span>
<span class="na">lr_start</span><span class="pi">:</span> <span class="m">0.0001</span>
<span class="na">lr_min</span><span class="pi">:</span> <span class="m">0.0001</span>
<span class="na">lr_max</span><span class="pi">:</span> <span class="m">0.0001</span>
<span class="na">lr_max_decay_steps</span><span class="pi">:</span> <span class="m">2000</span>

<span class="na">max_keep</span><span class="pi">:</span> <span class="m">100</span>
<span class="na">max_epochs</span><span class="pi">:</span> <span class="m">500</span>
<span class="na">save_interval</span><span class="pi">:</span> <span class="m">50</span>     <span class="c1"># take a snapshot every 50 epochs</span>
<span class="na">saved_name</span><span class="pi">:</span> <span class="s">pixelcnn</span>
<span class="na">log_folder</span><span class="pi">:</span> <span class="s">./logs/</span>   <span class="c1"># where to save the snapshots of the model</span>

<span class="na">num_prepare</span><span class="pi">:</span> <span class="m">10</span>
<span class="na">print_loss</span><span class="pi">:</span> <span class="s">True</span>
<span class="na">train_list</span><span class="pi">:</span> <span class="s">train_list</span> 
<span class="na">test_list</span><span class="pi">:</span>  <span class="s">test_list</span>

<span class="na">nr_gpu</span><span class="pi">:</span> <span class="m">4</span>
<span class="na">gpu_id</span><span class="pi">:</span> <span class="s1">'</span><span class="s">0,1,2,3'</span>
</code></pre></div></div> <h3 id="script-for-training">Script for training</h3> <p>After the configuration file is done, you need to write a script to start training that includes the read of configuration file, the initialization of the dataloader, and the start of the trainer. The below is an example. Once the training is started, you can use TensorBoard to monitor the losses for training by specifying where the log folder is.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="kn">from</span> <span class="n">spreco.common</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="n">spreco.trainer</span> <span class="kn">import</span> <span class="n">trainer</span>
<span class="kn">from</span> <span class="n">spreco.dataflow.base</span> <span class="kn">import</span> <span class="n">RNGDataFlow</span>
<span class="kn">from</span> <span class="n">spreco.dataflow.common</span> <span class="kn">import</span> <span class="n">BatchData</span>
<span class="kn">from</span> <span class="n">spreco.dataflow.parallel_map</span> <span class="kn">import</span> <span class="n">MultiThreadMapData</span>

<span class="kn">import</span> <span class="n">os</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">argparse</span>

<span class="k">class</span> <span class="nc">cfl_pipe</span><span class="p">(</span><span class="n">RNGDataFlow</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span> <span class="n">shuffle</span><span class="p">):</span>
        <span class="n">self</span><span class="p">.</span><span class="n">_size</span>   <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span>
        <span class="n">self</span><span class="p">.</span><span class="n">files</span>   <span class="o">=</span> <span class="n">files</span>
        <span class="n">self</span><span class="p">.</span><span class="n">shuffle</span> <span class="o">=</span> <span class="n">shuffle</span>
    
    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nf">len</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">files</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="n">self</span><span class="p">):</span>
        <span class="n">idxs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">_size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">self</span><span class="p">.</span><span class="n">shuffle</span><span class="p">:</span>
            <span class="n">self</span><span class="p">.</span><span class="n">rng</span><span class="p">.</span><span class="nf">shuffle</span><span class="p">(</span><span class="n">idxs</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">:</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">files</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">yield</span> <span class="n">fname</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">config_path</span><span class="p">):</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">utils</span><span class="p">.</span><span class="nf">load_config</span><span class="p">(</span><span class="n">config_path</span><span class="p">)</span>
        <span class="n">train_files</span> <span class="o">=</span> <span class="n">utils</span><span class="p">.</span><span class="nf">read_filelist</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="sh">'</span><span class="s">train_list</span><span class="sh">'</span><span class="p">])</span>
        <span class="n">test_files</span> <span class="o">=</span> <span class="n">utils</span><span class="p">.</span><span class="nf">read_filelist</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="sh">'</span><span class="s">test_list</span><span class="sh">'</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">load_file</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="sh">"""</span><span class="s">
        x     ---&gt; file path
        imgs  ---&gt; normalized images with shape (batch_size, x, y, 2) 
        </span><span class="sh">"""</span>
        <span class="n">path</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">splitext</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">squeeze</span><span class="p">(</span><span class="n">utils</span><span class="p">.</span><span class="nf">readcfl</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="n">imgs</span> <span class="o">/</span> <span class="n">np</span><span class="p">.</span><span class="nf">max</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="nf">abs</span><span class="p">(</span><span class="n">imgs</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span> <span class="n">keepdims</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">imgs</span> <span class="o">=</span> <span class="n">utils</span><span class="p">.</span><span class="nf">cplx2float</span><span class="p">(</span><span class="n">imgs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">imgs</span>

    <span class="k">def</span> <span class="nf">map_f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="nf">aug_load_file</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="sh">"</span><span class="s">inputs</span><span class="sh">"</span><span class="p">:</span> <span class="n">d</span><span class="p">}</span>
    
    <span class="n">nr_elm</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="sh">'</span><span class="s">batch_size</span><span class="sh">'</span><span class="p">]</span><span class="o">*</span><span class="n">config</span><span class="p">[</span><span class="sh">'</span><span class="s">nr_gpu</span><span class="sh">'</span><span class="p">]</span>

    <span class="n">d1</span> <span class="o">=</span> <span class="nf">cfl_pipe</span><span class="p">(</span><span class="n">train_files</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">d1</span> <span class="o">=</span> <span class="nc">MultiThreadMapData</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">num_thread</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="sh">'</span><span class="s">num_thread</span><span class="sh">'</span><span class="p">],</span> <span class="n">map_func</span><span class="o">=</span><span class="n">map_f</span><span class="p">,</span>  <span class="n">buffer_size</span><span class="o">=</span><span class="n">nr_elm</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">train_pipe</span> <span class="o">=</span> <span class="nc">BatchData</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">nr_elm</span><span class="p">,</span> <span class="n">use_list</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">d2</span> <span class="o">=</span> <span class="nf">cfl_pipe</span><span class="p">(</span><span class="n">test_files</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="nc">MultiThreadMapData</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="n">num_thread</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="sh">'</span><span class="s">num_thread</span><span class="sh">'</span><span class="p">],</span> <span class="n">map_func</span><span class="o">=</span><span class="n">map_f</span><span class="p">,</span>  <span class="n">buffer_size</span><span class="o">=</span><span class="n">nr_elm</span><span class="o">*</span><span class="mi">10</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">test_pipe</span> <span class="o">=</span> <span class="nc">BatchData</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="n">nr_elm</span><span class="p">,</span> <span class="n">use_list</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

    <span class="n">go</span> <span class="o">=</span> <span class="nf">trainer</span><span class="p">(</span><span class="n">train_pipe</span><span class="p">,</span> <span class="n">test_pipe</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
    <span class="n">utils</span><span class="p">.</span><span class="nf">log_to</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">go</span><span class="p">.</span><span class="n">log_path</span><span class="p">,</span> <span class="sh">'</span><span class="s">train_files</span><span class="sh">'</span><span class="p">),</span> <span class="n">train_files</span><span class="p">)</span>
    <span class="n">utils</span><span class="p">.</span><span class="nf">log_to</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">go</span><span class="p">.</span><span class="n">log_path</span><span class="p">,</span> <span class="sh">'</span><span class="s">test_files</span><span class="sh">'</span><span class="p">),</span> <span class="n">test_files</span><span class="p">)</span>
    <span class="n">utils</span><span class="p">.</span><span class="nf">log_to</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">go</span><span class="p">.</span><span class="n">log_path</span><span class="p">,</span> <span class="sh">'</span><span class="s">train_info</span><span class="sh">'</span><span class="p">),</span> <span class="p">[</span><span class="n">utils</span><span class="p">.</span><span class="nf">get_timestamp</span><span class="p">()</span> <span class="o">+</span> <span class="sh">"</span><span class="s">, the training is starting</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">go</span><span class="p">.</span><span class="nf">train</span><span class="p">()</span>
    <span class="n">utils</span><span class="p">.</span><span class="nf">log_to</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="n">go</span><span class="p">.</span><span class="n">log_path</span><span class="p">,</span> <span class="sh">'</span><span class="s">train_info</span><span class="sh">'</span><span class="p">),</span> <span class="p">[</span><span class="n">utils</span><span class="p">.</span><span class="nf">get_timestamp</span><span class="p">()</span> <span class="o">+</span> <span class="sh">"</span><span class="s">, the training is ending</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">utils</span><span class="p">.</span><span class="nf">color_print</span><span class="p">(</span><span class="sh">'</span><span class="s">TRAINING FINISHED at </span><span class="sh">'</span> <span class="o">+</span> <span class="n">utils</span><span class="p">.</span><span class="nf">get_timestamp</span><span class="p">())</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="p">.</span><span class="nc">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="sh">''</span><span class="p">)</span>
    <span class="n">parser</span><span class="p">.</span><span class="nf">add_argument</span><span class="p">(</span><span class="sh">'</span><span class="s">--config</span><span class="sh">'</span><span class="p">,</span> <span class="n">metavar</span><span class="o">=</span><span class="sh">'</span><span class="s">path</span><span class="sh">'</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="sh">'</span><span class="s">config file for training</span><span class="sh">'</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="sh">''</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="p">.</span><span class="nf">parse_args</span><span class="p">()</span>
    <span class="nf">main</span><span class="p">(</span><span class="n">args</span><span class="p">.</span><span class="n">config</span><span class="p">)</span>
</code></pre></div></div> <h2 id="export-and-inference">Export and inference</h2> <p>For every model in spreco, you can use the <code class="language-plaintext highlighter-rouge">exporter</code> module to export the trained models. It exports the neural network with default inputs and outputs. You can load the exported graph and inference it with <a href="https://github.com/mrirecon/bart" rel="external nofollow noopener" target="_blank">BART</a> toolbox. It is possible to customize the inputs and outputs. The below is an example for handling 2D MR images. Click here for <a href="https://github.com/ggluo/image-priors/blob/release/scripts/recon/create_graph.py" rel="external nofollow noopener" target="_blank">3D volumes</a>.</p> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">spreco.exporter</span> <span class="kn">import</span> <span class="n">exporter</span>
<span class="kn">from</span> <span class="n">spreco.common</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">import</span> <span class="n">tensorflow.compat.v1</span> <span class="k">as</span> <span class="n">tf</span>
<span class="n">tf</span><span class="p">.</span><span class="nf">disable_eager_execution</span><span class="p">()</span>

<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="n">e</span> <span class="o">=</span> <span class="nf">exporter</span><span class="p">(</span><span class="n">log</span>  <span class="o">=</span> <span class="sh">"</span><span class="s">./PixelCNN/cplx_large</span><span class="sh">"</span><span class="p">,</span>
             <span class="n">meta</span> <span class="o">=</span> <span class="sh">"</span><span class="s">pixelcnn</span><span class="sh">"</span><span class="p">,</span>
             <span class="n">default_out</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
             <span class="n">path</span><span class="o">=</span><span class="sh">"</span><span class="s">./PixelCNN/exported</span><span class="sh">"</span><span class="p">,</span>
             <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">cplx_large</span><span class="sh">"</span><span class="p">,</span> <span class="n">gpu_id</span><span class="o">=</span><span class="sh">'</span><span class="s">0</span><span class="sh">'</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">tf</span><span class="p">.</span><span class="nf">placeholder</span><span class="p">(</span><span class="n">tf</span><span class="p">.</span><span class="n">float32</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="sh">"</span><span class="s">input_0</span><span class="sh">"</span><span class="p">)</span>


<span class="n">logits</span> <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">loss</span>   <span class="o">=</span> <span class="n">e</span><span class="p">.</span><span class="n">model</span><span class="p">.</span><span class="nf">loss_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">logits</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="p">.</span><span class="nf">prod</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

<span class="n">e</span><span class="p">.</span><span class="nf">export</span><span class="p">([</span><span class="n">x</span><span class="p">],</span> <span class="p">[</span><span class="n">loss</span><span class="p">],</span> <span class="n">attach_gradients</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div> <p>We prepare a complete <a href="https://colab.research.google.com/github/ggluo/image-priors/blob/release/misc/demo_image_priors_colab.ipynb" rel="external nofollow noopener" target="_blank"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a> to demonstrate how to use the trained generative priors when using BART for image reconstruction.</p> <p>Once you have gone through the whole workflow, you can start to collect feedback and iterate models. If there is any question or feedback for us, feel free to leave them below.</p> </div> </article><div id="giscus_thread" style="max-width: 850px; margin: 0 auto;"> <script>let giscusTheme=localStorage.getItem("theme"),giscusAttributes={src:"https://giscus.app/client.js","data-repo":"alshedivat/al-folio","data-repo-id":"MDEwOlJlcG9zaXRvcnk2MDAyNDM2NQ==","data-category":"Comments","data-category-id":"DIC_kwDOA5PmLc4CTBt6","data-mapping":"title","data-strict":"1","data-reactions-enabled":"1","data-emit-metadata":"0","data-input-position":"bottom","data-theme":giscusTheme,"data-lang":"en",crossorigin:"anonymous",async:""},giscusScript=document.createElement("script");Object.entries(giscusAttributes).forEach(([t,a])=>giscusScript.setAttribute(t,a)),document.getElementById("giscus_thread").appendChild(giscusScript);</script> <noscript>Please enable JavaScript to view the <a href="http://giscus.app/?ref_noscript" rel="external nofollow noopener" target="_blank">comments powered by giscus.</a> </noscript> </div> </div> </div> <div class="col-sm-3"> <nav id="toc-sidebar" class="sticky-top"></nav> </div> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2023 Guanxiong Jason Luo. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.8/dist/medium-zoom.min.js" integrity="sha256-7PhEpEWEW0XXQ0k6kQrPKwuoIomz8R8IYyuU1Qew4P8=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script> <script defer src="https://unpkg.com/bootstrap-table@1.21.4/dist/bootstrap-table.min.js"></script> <script src="/assets/js/no_defer.js"></script> <script defer src="/assets/js/common.js"></script> <script defer src="/assets/js/copy_code.js" type="text/javascript"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>